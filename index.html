<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel de Gestão da Rotina Semanal - AutoPrime</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0; /* Remove margem padrão */
            padding: 20px;
            background-color: #f4f7f6;
            color: #333;
        }
        .container {
            max-width: 1200px;
            margin: auto;
            background: #fff;
            padding: 15px; /* Reduzido para mobile */
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        h1 {
            color: #0056b3;
            text-align: center;
            margin-bottom: 15px;
            font-size: 1.8em; /* Ajuste para mobile */
        }
        h2 {
            font-size: 1.4em;
            margin-bottom: 10px;
        }
        /* --- Tabs e Botões (Estilos Mantidos) --- */
        .tab-container { display: flex; margin-bottom: 20px; border-bottom: 2px solid #ddd; overflow-x: auto; }
        .tab-button {
            padding: 10px 15px;
            cursor: pointer;
            border: none;
            background-color: #f1f1f1;
            border-top-left-radius: 8px;
            border-top-right-radius: 8px;
            margin-right: 5px;
            font-size: 1em;
            font-weight: 600;
            color: #555;
            flex-shrink: 0; /* Impede que os botões diminuam */
        }
        .tab-button.active { background-color: #0056b3; color: white; border-bottom: 2px solid #0056b3; }
        .tab-content { display: none; padding-top: 5px; }
        .tab-content.active { display: block; }
        
        .progress-bar {
            height: 25px; /* Ajuste para mobile */
            line-height: 25px;
            /* Outros estilos de progresso mantidos */
            background-color: #28a745;
            width: 0%;
            text-align: center;
            color: white;
            border-radius: 6px;
            transition: width 0.4s ease;
            font-weight: bold;
        }
        
        /* --- Tabela Base (Desktop) --- */
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
            font-size: 0.9em;
            display: table; /* Padrão para desktop */
        }
        th, td {
            padding: 10px 8px;
            text-align: left;
            border-bottom: 1px solid #eee;
            vertical-align: top;
        }
        th { background-color: #0056b3; color: white; font-weight: 600; }
        
        /* --- Estilos de Botões (Mantidos) --- */
        .btn { padding: 6px 10px; border-radius: 5px; cursor: pointer; font-weight: bold; margin-bottom: 5px; font-size: 0.9em; }
        .btn-start { background-color: #007bff; color: white; }
        .btn-finish { background-color: #dc3545; color: white; }
        .btn-export { background-color: #6f42c1; color: white; margin-right: 10px; margin-top: 15px; }
        .reset-btn { background-color: #6c757d; color: white; margin-top: 15px; float: right; }
        .action-controls { display: flex; align-items: center; justify-content: space-between; margin-top: 15px; flex-wrap: wrap; }
        
        /* --- Ocultar na Impressão (Mantido) --- */
        @media print {
            .no-print { display: none !important; }
        }

        /* ====================================================
           RESPONSIVIDADE: MÍDIA QUERY PARA TELAS PEQUENAS (Mobile)
           ====================================================
        */
        @media screen and (max-width: 768px) {
            .container { padding: 10px; }
            
            /* Transforma a tabela em cartões de lista */
            table {
                border: 0;
                width: 100%;
                display: block; /* Tabela agora se comporta como um div */
            }
            thead {
                display: none; /* Oculta o cabeçalho original */
            }
            tr {
                border: 1px solid #ccc;
                display: block;
                margin-bottom: 15px;
                border-radius: 8px;
            }
            td {
                border-bottom: 1px solid #ddd;
                display: block; /* Cada célula vira uma linha */
                text-align: right;
                padding: 8px;
                font-size: 1em;
                position: relative;
            }
            td:before {
                /* Exibe o nome da coluna como um label */
                content: attr(data-label); 
                float: left;
                font-weight: bold;
                text-transform: uppercase;
                margin-right: 10px;
                color: #0056b3;
            }
            td:last-child {
                border-bottom: 0;
            }
            
            /* Ajuste para controles de ação em mobile */
            .action-controls {
                flex-direction: column;
                align-items: stretch;
            }
            .btn-export, .reset-btn {
                width: 100%;
                margin: 5px 0;
                float: none;
            }
            .tab-container {
                /* Garante que o container de tabs seja rolavel horizontalmente */
                white-space: nowrap;
            }
        }
    </style>
</head>
<body>

<div class="container">
    <h1>Painel de Produtividade Semanal (Check-in/Check-out)</h1>
    
    <div class="tab-container">
        <button class="tab-button active" onclick="openTab('AcademiaAutoPrime', event)">AcademiaAutoPrime</button>
        <button class="tab-button" onclick="openTab('RedeAutoPrime', event)">RedeAutoPrime</button>
        <button class="tab-button" onclick="openTab('VagasAutoPrime', event)">VagasAutoPrime</button>
    </div>

    <div id="AcademiaAutoPrime" class="tab-content active">
        <h2>Relatório de Execução - AcademiaAutoPrime</h2>
        <div class="progress-container">
            <h3>Progresso Semanal: <span id="progress-text-AcademiaAutoPrime">0%</span></h3>
            <div class="progress-bar" id="weekly-progress-bar-AcademiaAutoPrime"></div>
        </div>
        <table id="table-AcademiaAutoPrime">
            <thead>
                <tr>
                    <th style="width: 8%;">Dia</th>
                    <th style="width: 25%;">Foco da Tarefa</th>
                    <th style="width: 15%;">Check-in (Data/Hora)</th>
                    <th style="width: 15%;">Check-out (Data/Hora)</th>
                    <th style="width: 10%;">Duração</th>
                    <th class="no-print" style="width: 14%;">Ação</th>
                    <th style="width: 8%;">Status</th>
                </tr>
            </thead>
            <tbody id="task-list-AcademiaAutoPrime"></tbody>
        </table>
        <div class="action-controls no-print">
            <button class="btn btn-export" onclick="exportReport('AcademiaAutoPrime')">Exportar Relatório (PDF)</button>
            <button class="btn reset-btn" onclick="resetAll('AcademiaAutoPrime')">Reiniciar Semana (Academia)</button>
        </div>
    </div>

    <div id="RedeAutoPrime" class="tab-content">
        <h2>Relatório de Execução - RedeAutoPrime</h2>
        <div class="progress-container">
            <h3>Progresso Semanal: <span id="progress-text-RedeAutoPrime">0%</span></h3>
            <div class="progress-bar" id="weekly-progress-bar-RedeAutoPrime"></div>
        </div>
        <table id="table-RedeAutoPrime">
            <thead>
                <tr>
                    <th style="width: 8%;">Dia</th>
                    <th style="width: 25%;">Foco da Tarefa</th>
                    <th style="width: 15%;">Check-in (Data/Hora)</th>
                    <th style="width: 15%;">Check-out (Data/Hora)</th>
                    <th style="width: 10%;">Duração</th>
                    <th class="no-print" style="width: 14%;">Ação</th>
                    <th style="width: 8%;">Status</th>
                </tr>
            </thead>
            <tbody id="task-list-RedeAutoPrime"></tbody>
        </table>
        <div class="action-controls no-print">
            <button class="btn btn-export" onclick="exportReport('RedeAutoPrime')">Exportar Relatório (PDF)</button>
            <button class="btn reset-btn" onclick="resetAll('RedeAutoPrime')">Reiniciar Semana (Rede)</button>
        </div>
    </div>

    <div id="VagasAutoPrime" class="tab-content">
        <h2>Relatório de Execução - VagasAutoPrime</h2>
        <div class="progress-container">
            <h3>Progresso Semanal: <span id="progress-text-VagasAutoPrime">0%</span></h3>
            <div class="progress-bar" id="weekly-progress-bar-VagasAutoPrime"></div>
        </div>
        <table id="table-VagasAutoPrime">
            <thead>
                <tr>
                    <th style="width: 8%;">Dia</th>
                    <th style="width: 25%;">Foco da Tarefa</th>
                    <th style="width: 15%;">Check-in (Data/Hora)</th>
                    <th style="width: 15%;">Check-out (Data/Hora)</th>
                    <th style="width: 10%;">Duração</th>
                    <th class="no-print" style="width: 14%;">Ação</th>
                    <th style="width: 8%;">Status</th>
                </tr>
            </thead>
            <tbody id="task-list-VagasAutoPrime"></tbody>
        </table>
        <div class="action-controls no-print">
            <button class="btn btn-export" onclick="exportReport('VagasAutoPrime')">Exportar Relatório (PDF)</button>
            <button class="btn reset-btn" onclick="resetAll('VagasAutoPrime')">Reiniciar Semana (Vagas)</button>
        </div>
    </div>

</div>

<script>
    const companies = ['AcademiaAutoPrime', 'RedeAutoPrime', 'VagasAutoPrime'];
    let currentActiveCompany = 'AcademiaAutoPrime';

    // Lista de tarefas BASEADA NA ESTRUTURA SEMANAL DA SUA TABELA
    const baseTasks = [
        { id: 'seg_plan', day: 'Segunda', name: 'Planejamento de Conteúdo e Justificativas (08:30 - 12:00)' },
        { id: 'seg_leg', day: 'Segunda', name: 'Criação de Legendas e Roteiros (13:00 - 17:00)' },
        { id: 'ter_art', day: 'Terça', name: 'Criação de Artes e Edição de Vídeos (08:30 - 15:30)' },
        { id: 'ter_age', day: 'Terça', name: 'Agendamento de Conteúdo (15:30 - 17:00)' },
        { id: 'qua_eng', day: 'Quarta', name: 'Engajamento e Atendimento Proativo (08:00 - 11:00)' },
        { id: 'qua_pes', day: 'Quarta', name: 'Pesquisa de Tendências e Ideias (13:00 - 15:00)' },
        { id: 'qui_pro', day: 'Quinta', name: 'Prospecção e Interação Ativa (09:00 - 10:30)' },
        { id: 'qui_ana', day: 'Quinta', name: 'Análise e Relatório de Métricas (13:00 - 17:00)' },
        { id: 'sex_org', day: 'Sexta', name: 'Fechamento e Organização Digital (09:00 - 12:00)' },
        { id: 'sex_ali', day: 'Sexta', name: 'Alinhamento e Feedback (14:00 - 15:00)' }
    ];

    let allTaskStatus = JSON.parse(localStorage.getItem('workflowTasks_multicompany')) || {};

    companies.forEach(comp => {
        if (!allTaskStatus[comp]) {
            allTaskStatus[comp] = {};
        }
    });

    // --- Funções de Tempo e Formatação ---

    const formatDateTime = (dateString) => {
        if (!dateString) return '—';
        const d = new Date(dateString);
        // Formato DD/MM/AAAA HH:MM:SS
        const datePart = d.toLocaleDateString('pt-BR');
        const timePart = d.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
        return `<span style="white-space: nowrap;">${datePart}</span><br>${timePart}`;
    };

    const formatDuration = (startTime, endTime) => {
        if (!startTime || !endTime) return '—';
        const durationMs = new Date(endTime) - new Date(startTime);
        const hours = Math.floor(durationMs / (1000 * 60 * 60));
        const minutes = Math.floor((durationMs % (1000 * 60 * 60)) / (1000 * 60));
        return `${hours}h ${minutes}m`;
    };

    // --- Funções de Renderização e Lógica ---

    const renderTasks = (company) => {
        const list = document.getElementById(`task-list-${company}`);
        list.innerHTML = '';
        const taskStatus = allTaskStatus[company];
        const totalTasks = baseTasks.length;
        let completedTasks = 0;

        // Títulos das colunas (para uso em Mobile)
        const headers = ['Dia', 'Foco da Tarefa', 'Check-in (Data/Hora)', 'Check-out (Data/Hora)', 'Duração', 'Ação', 'Status'];

        baseTasks.forEach(task => {
            const status = taskStatus[task.id] || {};
            const startTime = status.checkInTime;
            const endTime = status.checkOutTime;
            const isFinished = !!endTime;
            const isInProgress = !!startTime && !endTime;

            if (isFinished) completedTasks++;

            const statusClass = isFinished ? 'status-done' : (isInProgress ? 'status-inprogress' : '');
            const statusText = isFinished ? 'Concluído' : (isInProgress ? 'Em Execução' : 'Pendente');
            
            const actionButton = `
                ${!isInProgress && !isFinished ? `<button class="btn btn-start" onclick="checkIn('${company}', '${task.id}')">Check-in</button>` : ''}
                ${isInProgress ? `<button class="btn btn-finish" onclick="checkOut('${company}', '${task.id}')">Check-out</button>` : ''}
                ${isFinished ? '—' : ''}
            `;
            
            const row = list.insertRow();
            // Adiciona o atributo data-label em cada <td> para responsividade mobile
            row.innerHTML = `
                <td data-label="${headers[0]}">${task.day}</td>
                <td data-label="${headers[1]}">${task.name}</td>
                <td data-label="${headers[2]}">${formatDateTime(startTime)}</td>
                <td data-label="${headers[3]}">${formatDateTime(endTime)}</td>
                <td data-label="${headers[4]}">${formatDuration(startTime, endTime)}</td>
                <td class="no-print" data-label="${headers[5]}">${actionButton}</td>
                <td data-label="${headers[6]}"><span class="${statusClass}">${statusText}</span></td>
            `;
        });

        updateProgress(company, totalTasks, completedTasks);
        saveStatus();
    };

    const checkIn = (company, taskId) => {
        // Logoff automático de outras tarefas em andamento (foco único)
        const currentTasks = allTaskStatus[company];
        for (const id in currentTasks) {
            if (currentTasks[id].checkInTime && !currentTasks[id].checkOutTime && id !== taskId) {
                // Se houver uma tarefa em andamento, faz o checkout automático dela
                currentTasks[id].checkOutTime = new Date().toISOString();
            }
        }
        
        if (allTaskStatus[company][taskId] && allTaskStatus[company][taskId].checkInTime && !allTaskStatus[company][taskId].checkOutTime) return;

        allTaskStatus[company][taskId] = {
            checkInTime: new Date().toISOString(),
            checkOutTime: null
        };
        renderTasks(company);
    };

    const checkOut = (company, taskId) => {
        if (!allTaskStatus[company][taskId] || allTaskStatus[company][taskId].checkOutTime) return;

        allTaskStatus[company][taskId].checkOutTime = new Date().toISOString();
        renderTasks(company);
    };

    const updateProgress = (company, total, completed) => {
        const percentage = total > 0 ? Math.round((completed / total) * 100) : 0;
        const progressBar = document.getElementById(`weekly-progress-bar-${company}`);
        const progressText = document.getElementById(`progress-text-${company}`);

        progressBar.style.width = `${percentage}%`;
        progressText.textContent = `${percentage}%`;
        progressBar.textContent = percentage > 5 ? `${percentage}%` : '';

        // Lógica de cor da barra de progresso
        progressText.style.color = (percentage <= 5 && percentage > 0) ? '#333' : 'white';
        if (percentage > 5) {
            progressBar.style.backgroundColor = '#28a745';
        } else if (percentage > 0) {
            progressBar.style.backgroundColor = '#ffc107';
        } else {
            progressBar.style.backgroundColor = '#e9ecef';
            progressText.style.color = '#333';
        }
    };

    const saveStatus = () => {
        localStorage.setItem('workflowTasks_multicompany', JSON.stringify(allTaskStatus));
    };

    const resetAll = (company) => {
        if (confirm(`Tem certeza que deseja REINICIAR o progresso de TODAS as tarefas da ${company}? Esta ação é irreversível.`)) {
            allTaskStatus[company] = {};
            saveStatus();
            renderTasks(company);
        }
    };

    // --- Funções de Navegação e Exportação ---

    const openTab = (companyName, event) => {
        currentActiveCompany = companyName;
        
        document.querySelectorAll('.tab-content').forEach(content => {
            content.classList.remove('active');
        });
        document.getElementById(companyName).classList.add('active');

        document.querySelectorAll('.tab-button').forEach(button => {
            button.classList.remove('active');
        });
        if (event && event.currentTarget) {
             event.currentTarget.classList.add('active');
        } else {
             // Garante que o botão certo seja ativado na inicialização
             document.querySelector(`.tab-button[onclick*="'${companyName}'"]`).classList.add('active');
        }
        
        renderTasks(companyName);
    };

    const exportReport = (company) => {
        const element = document.getElementById(company);
        const today = new Date().toLocaleDateString('pt-BR').replace(/\//g, '-');
        
        // Configurações para o PDF
        const opt = {
            margin:       0.5,
            filename:     `Relatorio_Workflow_${company}_${today}.pdf`,
            image:        { type: 'jpeg', quality: 0.98 },
            html2canvas:  { scale: 2, logging: true },
            jsPDF:        { unit: 'in', format: 'letter', orientation: 'portrait' }
        };
        
        // Clona o elemento para prepará-lo para a impressão (limpando o botão de Ação)
        const elementToPrint = element.cloneNode(true);
        
        // Remove a coluna de Ação do CLONE da tabela (se existir)
        const actionHeader = elementToPrint.querySelector('thead tr th:nth-child(6)');
        if (actionHeader && actionHeader.classList.contains('no-print')) {
            actionHeader.remove();
        }
        elementToPrint.querySelectorAll('tbody tr').forEach(row => {
            const actionCell = row.querySelector('td:nth-child(6)');
            if (actionCell && actionCell.classList.contains('no-print')) {
                actionCell.remove();
            }
        });

        // Remove botões de controle do clone
        elementToPrint.querySelector('.action-controls').remove();
        
        // Adiciona um título claro ao relatório
        const header = document.createElement('h2');
        header.textContent = `Relatório Semanal de Execução - ${company} (${today})`;
        
        const wrapper = document.createElement('div');
        wrapper.appendChild(header);
        wrapper.appendChild(elementToPrint.querySelector('.progress-container').cloneNode(true));
        wrapper.appendChild(elementToPrint.querySelector('table').cloneNode(true));

        // Chama a função da biblioteca para gerar o PDF
        html2pdf().set(opt).from(wrapper).save();
    };

    // --- Inicialização ---

    window.onload = () => {
        companies.forEach(company => renderTasks(company));
        
        // Garante que a aba da primeira empresa esteja ativa ao carregar
        openTab(companies[0]); 
    };

</script>

</body>
</html>
